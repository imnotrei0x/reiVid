<!DOCTYPE html>
<html>
<head>
    <title>reiVid</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="icon" type="image/png" href="/assets/logo.png">
    <meta name="msapplication-TileImage" content="/assets/favicon.ico">
    <meta property="og:image" content="/assets/logo.png">
    <link rel="stylesheet" href="/styles/styles.css">
    <style>
        .fade-out {
            opacity: 0 !important;
            transition: opacity 0.3s ease-out;
        }
        
        #landing {
            opacity: 1;
            transition: opacity 0.3s ease-in;
        }
    </style>
    <script>
        // Add this helper function for IndexedDB operations
        const videoStore = {
            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('VideoDatabase', 1);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('videos')) {
                            db.createObjectStore('videos');
                        }
                    };
                });
            },
            
            async storeVideo(blob) {
                const db = await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['videos'], 'readwrite');
                    const store = transaction.objectStore('videos');
                    const request = store.put(blob, 'pendingVideo');
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve();
                });
            },
            
            async cleanup() {
                const db = await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['videos'], 'readwrite');
                    const store = transaction.objectStore('videos');
                    const request = store.delete('pendingVideo');
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve();
                });
            }
        };

        function handleFileSelect() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'video/*';
            fileInput.style.display = 'none';
            
            fileInput.onchange = async function(e) {
                const file = e.target.files[0];
                if (file) {
                    const maxSize = 100 * 1024 * 1024; 
                    if (file.size > maxSize) {
                        alert('File is too large. Maximum size is 100MB');
                        return;
                    }
                    
                    try {
                        await videoStore.storeVideo(file);
                        
                        const landing = document.getElementById('landing');
                        landing.classList.add('fade-out');
                        
                        setTimeout(() => {
                            window.location.href = '/editor';
                        }, 300);
                    } catch (error) {
                        alert('Error preparing video. Please try a smaller file.');
                        console.error('Error:', error);
                    }
                }
            };
            
            fileInput.click();
        }

        window.addEventListener('load', () => {
            videoStore.cleanup().catch(console.error);
        });
    </script>
</head>
<body>
    <div class="container" id="landing">
        <div class="header">
            <img src="/assets/logo.png" alt="reiVid" class="logo">
            <h1>reiVid</h1>
        </div>
        <p class="description">trim and crop videos in your browser</p>
        <button class="upload-button" onclick="handleFileSelect()">Select Video</button>
        
        <div class="footer-links">
            <a href="/about">about</a>
            <a href="/donate">donate</a>
            <a href="/terms">terms</a>
            <a href="/privacy">privacy</a>
        </div>
    </div>
</body>
</html>